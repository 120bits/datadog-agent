---
.if_version_7: &if_version_7
  if: $RELEASE_VERSION_7 != ""

windows_choco_offline_7_x64:
  rules:
    - <<: *if_version_7
      when: manual
      allow_failure: true
  stage: image_build
  tags: ["runner:windows-docker", "windowsversion:1809"]
  needs: ["windows_msi_and_bosh_zip_x64-a7"]
  variables:
    ARCH: "x64"
  script:
    - $ErrorActionPreference = "Stop"
    - Get-ChildItem .omnibus\pkg
    - copy .omnibus\pkg\*.msi .\chocolatey\tools-offline\
    - docker run --rm -v "$(Get-Location):c:\mnt" 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/windows_1809_${ARCH}:$Env:DATADOG_AGENT_WINBUILDIMAGES c:\mnt\tasks\winbuildscripts\chocopack.bat offline
    - If ($lastExitCode -ne "0") { throw "Previous command returned $lastExitCode" }
    - copy build-out\*.nupkg .omnibus\pkg
  artifacts:
    expire_in: 2 weeks
    paths:
      - .omnibus/pkg
